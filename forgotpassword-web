import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';
import 'package:your_app/main.dart' 
import 'package:flutter/material.dart';

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  group('Forgot Password Flow - Automation Test', () {
    testWidgets('Happy Path: Valid registered email triggers reset email',
        (WidgetTester tester) async {
      
      app.main();
      await tester.pumpAndSettle();

     
      // If app starts on a different screen, add navigation steps here
      expect(find.textContaining('Login'), findsOneWidget); // Adjust to your login screen identifier

 
      final forgotPasswordFinder = find.text('Forgot Password?'); // Adjust text if different
      await tester.tap(forgotPasswordFinder);
      await tester.pumpAndSettle();

    
      expect(find.textContaining('Reset Password'), findsOneWidget); // Adjust title as needed
      expect(find.byType(TextField), findsOneWidget); // Email input field

      final emailField = find.byType(TextField).first;
      expect(tester.widget<TextField>(emailField).enabled, isTrue);

   
      const validEmail = 'QA.reporting@bloomwell.de'; // As specified in task
      await tester.enterText(emailField, validEmail);
      await tester.pumpAndSettle();


      final submitButton = find.text('Send Reset Link'); // Adjust button text if different
      await tester.tap(submitButton);
      await tester.pumpAndSettle();

      // Verify success indication (e.g. success message or navigation)
      // Adjust based on your actual success UI (snackbar, dialog, new screen, etc.)
      expect(find.textContaining('sent'), findsOneWidget); // e.g. "Password reset email sent"
      // Note: Actual email delivery is verified manually/via mail catcher in QA env
    });

    testWidgets('Error: Empty email field - submission blocked', (WidgetTester tester) async {
      app.main();
      await tester.pumpAndSettle();

     
      await tester.tap(find.text('Forgot Password?'));
      await tester.pumpAndSettle();

      final submitButton = find.text('Send Reset Link');
      await tester.tap(submitButton);
      await tester.pump();

    
      expect(find.textContaining('required'), findsOneWidget); // Adjust to your error message
      expect(find.textContaining('sent'), findsNothing); // No success message
    });

    testWidgets('Error: Invalid email format - error message under field', (WidgetTester tester) async {
      app.main();
      await tester.pumpAndSettle();

      await tester.tap(find.text('Forgot Password?'));
      await tester.pumpAndSettle();

      final emailField = find.byType(TextField).first;

      // Try different invalid formats
      final invalidEmails = ['invalid', 'test@', '@example.com', 'test.com'];

      for (final email in invalidEmails) {
        await tester.enterText(emailField, email);
        await tester.pumpAndSettle();

        final submitButton = find.text('Send Reset Link');
        await tester.tap(submitButton);
        await tester.pump();

    
        expect(find.textContaining('valid email'), findsOneWidget); // Adjust to your actual message
        expect(find.textContaining('sent'), findsNothing);
      }
    });

    testWidgets('Error: Unregistered email - no success, form remains', (WidgetTester tester) async {
      app.main();
      await tester.pumpAndSettle();

      await tester.tap(find.text('Forgot Password?'));
      await tester.pumpAndSettle();

      const unregisteredEmail = 'nonexistent.user@bloomwell.de';

      await tester.enterText(find.byType(TextField).first, unregisteredEmail);
      await tester.pumpAndSettle();

      await tester.tap(find.text('Send Reset Link'));
      await tester.pumpAndSettle();

  
      expect(find.textContaining('sent'), findsNothing);
      expect(find.byType(TextField), findsOneWidget);
      expect(tester.widget<TextField>(find.byType(TextField).first).enabled, isTrue);
    });

    testWidgets('Validation blocks navigation on invalid input', (WidgetTester tester) async {
      app.main();
      await tester.pumpAndSettle();

      await tester.tap(find.text('Forgot Password?'));
      await tester.pumpAndSettle();

      await tester.enterText(find.byType(TextField).first, 'invalid-email');
      await tester.pumpAndSettle();

      // Try to tap submit multiple times
      final submitButton = find.text('Send Reset Link');
      await tester.tap(submitButton);
      await tester.pumpAndSettle();

      // Should still be on Forgot Password screen
      expect(find.textContaining('Reset Password'), findsOneWidget);
      expect(find.textContaining('valid email'), findsOneWidget); // Error remains visible
    });
  });
}
